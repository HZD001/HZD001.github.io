const Timer={config:null,startTime:null,endTime:null,lunchStartTime:null,lunchEndTime:null,totalWorkSeconds:0,interval:null,isRunning:false,lastBreakTime:null,isOnBreak:false,breakInterval:null,breakRemainingSeconds:0,breakModalTimeout:null,breakStartTime:null,breakModalShown:false,skipBreakCountdown:15,skipBreakInterval:null,isOvertime:false,overtimeStartTime:null,overtimeSeconds:0,elements:{timerDisplay:null,status:null,progressFill:null,startBtn:null,resetBtn:null,startTimeDisplay:null,endTimeDisplay:null,settingsBtn:null,settingsModal:null,closeBtn:null,cancelBtn:null,saveBtn:null,breakModal:null,breakTimer:null,skipBreakBtn:null,startBreakBtn:null,},init(){this.config=Config.loadConfig();this._0x0();this._0x1();this._0x2();Config.applyConfigToUI(this.config);NotificationManager.init(this.config);},_0x0(){this.elements.timerDisplay=document.querySelector(".timer-display .time");this.elements.status=document.getElementById("status");this.elements.progressFill=document.getElementById("progressFill");this.elements.startBtn=document.getElementById("startBtn");this.elements.resetBtn=document.getElementById("resetBtn");this.elements.startTimeDisplay=document.getElementById("startTime");this.elements.endTimeDisplay=document.getElementById("endTime");this.elements.settingsBtn=document.getElementById("settingsBtn");this.elements.settingsModal=document.getElementById("settingsModal");this.elements.closeBtn=document.getElementById("closeBtn");this.elements.cancelBtn=document.getElementById("cancelBtn");this.elements.saveBtn=document.getElementById("saveBtn");this.elements.breakModal=document.getElementById("breakModal");this.elements.breakTimer=document.getElementById("breakTimer");this.elements.skipBreakBtn=document.getElementById("skipBreakBtn");this.elements.startBreakBtn=document.getElementById("startBreakBtn");},_0x1(){this.elements.startBtn.addEventListener("click",()=> this._0x4());this.elements.resetBtn.addEventListener("click",()=> this.reset());this.elements.settingsBtn.addEventListener("click",()=> this._0x19());this.elements.closeBtn.addEventListener("click",()=> this._0x1a());this.elements.cancelBtn.addEventListener("click",()=> this._0x1a());this.elements.saveBtn.addEventListener("click",()=> this._0x1b());document .getElementById("testLunchBtn").addEventListener("click",()=> this._0x22());document .getElementById("testOffWorkBtn").addEventListener("click",()=> this._0x23());document .getElementById("testBreakBtn").addEventListener("click",()=> this._0x24());document .getElementById("checkPermissionBtn").addEventListener("click",()=> this.checkNotificationPermission());document .getElementById("setBeforeOffWorkBtn").addEventListener("click",()=> this._0x25());document .getElementById("enableDevMode").addEventListener("change",(e)=> this._0x2a(e));document .getElementById("soundType").addEventListener("change",(e)=> this._0x28(e));document .getElementById("customSound").addEventListener("change",(e)=> this._0x29(e));this.elements.skipBreakBtn.addEventListener("click",()=> this._0x12());this.elements.startBreakBtn.addEventListener("click",()=> this._0x13());},_0x2(){const _0x3=Config.loadTimerState();if(_0x3){this.startTime=new Date(_0x3.startTime);this.endTime=new Date(_0x3.endTime);this.lunchStartTime=new Date(_0x3.lunchStartTime);this.lunchEndTime=new Date(_0x3.lunchEndTime);this.totalWorkSeconds=_0x3.totalWorkSeconds;this.elements.startTimeDisplay.textContent=Utils.formatTimeHHMM(this.startTime);this.elements.endTimeDisplay.textContent=Utils.formatTimeHHMM(this.endTime);const now=new Date();if(_0x3.isOvertime&&_0x3.overtimeStartTime){this.isOvertime=true;this.overtimeStartTime=new Date(_0x3.overtimeStartTime);this._0x16();}else if(now < this.endTime){this._0x5(true);}else{Config.clearTimerState();}}},_0x4(){if(this.isRunning){this._0x6();}else{if(this.elements.startBtn.textContent==="å¼€å§‹åŠ ç­"){this._0x16();}else{this._0x5();}}},_0x5(isResuming=false){if(!isResuming){this._0x7();this._0x18();}this.isRunning=true;this.elements.startBtn.textContent="æš‚åœ";this.elements.resetBtn.disabled=false;this._0xc();this.interval=setInterval(()=> this._0xb(),1000);},_0x6(){this.isRunning=false;if(this.isOvertime){this.elements.startBtn.textContent="ç»§ç»­åŠ ç­";}else{this.elements.startBtn.textContent="ç»§ç»­";}clearInterval(this.interval);},reset(){this.isRunning=false;clearInterval(this.interval);if(this.breakInterval){clearInterval(this.breakInterval);this.breakInterval=null;}if(this.breakModalTimeout){clearTimeout(this.breakModalTimeout);this.breakModalTimeout=null;}if(this.skipBreakInterval){clearInterval(this.skipBreakInterval);this.skipBreakInterval=null;}this.isOnBreak=false;this.breakModalShown=false;this.elements.breakModal.classList.remove("active");this.elements.skipBreakBtn.textContent="è·³è¿‡ä¼‘æ¯";this.startTime=null;this.endTime=null;this.lunchStartTime=null;this.lunchEndTime=null;this.totalWorkSeconds=0;this.lastBreakTime=null;this.isOvertime=false;this.overtimeStartTime=null;this.overtimeSeconds=0;this.config.startWorkTime="";Config.saveConfig(this.config);document.getElementById("startWorkTime").value="";Config.clearTimerState();NotificationManager.reset();this.elements.startBtn.textContent="å¼€å§‹ä¸Šç­";this.elements.resetBtn.disabled=true;this.elements.timerDisplay.textContent="00:00:00";this.elements.status.textContent="ç‚¹å‡»å¼€å§‹æŒ‰é’®ä¸Šç­æ‰“å¡";this.elements.progressFill.style.width="0%";this.elements.startTimeDisplay.textContent="--:--";this.elements.endTimeDisplay.textContent="--:--";},_0x7(){const now=new Date();const _0x8=this.config.startWorkTime;if(_0x8&&_0x8.trim()!==""){const _0x9=Utils.parseTimeString(_0x8);this.startTime=Utils.setTimeToDate(now,_0x9.hours,_0x9.minutes);const offsetTime=Utils.parseTimeString(this.config.clockOffsetTime||"00:00");const offsetMinutes=offsetTime.hours * 60 + offsetTime.minutes;if(this.config.clockOffsetType==="slow"){this.startTime=new Date(this.startTime.getTime()+ offsetMinutes * 60000);}else{this.startTime=new Date(this.startTime.getTime()- offsetMinutes * 60000);}}else{this.startTime=new Date(now);}const _0xa=Utils.parseTimeString(this.config.lunchTime);this.lunchStartTime=Utils.setTimeToDate(this.startTime,_0xa.hours,_0xa.minutes);if(this.lunchStartTime <=this.startTime){this.lunchStartTime.setDate(this.lunchStartTime.getDate()+ 1);}this.lunchEndTime=new Date(this.lunchStartTime.getTime()+ this.config.lunchBreak * 60000);this.totalWorkSeconds=this.config.workHours * 3600;this.endTime=new Date(this.startTime.getTime()+ this.totalWorkSeconds * 1000 + this.config.lunchBreak * 60000);this.elements.startTimeDisplay.textContent=Utils.formatTimeHHMM(this.startTime);this.elements.endTimeDisplay.textContent=Utils.formatTimeHHMM(this.endTime);},_0xb(){if(!this.isOnBreak){if(this.isOvertime){this._0x17();}else{this._0xc();this._0xe();}}},_0xc(){const now=new Date();const remainingSeconds=Utils.getSecondsDiff(this.endTime,now);if(remainingSeconds <=0){this._0x15();return;}this.elements.timerDisplay.textContent=Utils.formatTime(remainingSeconds);const _0xd=Utils.isInLunchBreak(now,this.lunchStartTime,this.config.lunchBreak);if(this.isOnBreak){this.elements.status.textContent="ä¼‘æ¯ä¸­ï¼Œæ”¾æ¾ä¸€ä¸‹~";}else if(_0xd){this.elements.status.textContent="åˆä¼‘æ—¶é—´ï¼Œå¥½å¥½ä¼‘æ¯~";}else{this.elements.status.textContent="æ­£åœ¨åŠªåŠ›å·¥ä½œä¸­...";}const elapsedSeconds=Utils.getSecondsDiff(now,this.startTime);const progress=Utils.calculateProgress(elapsedSeconds,this.totalWorkSeconds);this.elements.progressFill.style.width=`${progress}%`;},_0xe(){const now=new Date();if(this.config.enableLunchNotify&&now >=this.lunchStartTime&&now < this.lunchEndTime){NotificationManager.notifyLunch();}if(this.config.enableOffWorkNotify&&now >=this.endTime){NotificationManager.notifyOffWork();}if(this.config.enableBreakReminder&&this.isRunning){this._0xf(now);}},_0xf(now){if(!this.lastBreakTime){this.lastBreakTime=new Date();}if(now >=this.endTime){return;}const _0xd=Utils.isInLunchBreak(now,this.lunchStartTime,this.config.lunchBreak);if(_0xd){return;}const _0x10=Math.floor((now - this.lastBreakTime)/ 60000);if(_0x10 >=this.config.breakInterval&&!this.breakModalShown){this._0x11();}},_0x11(){this.breakRemainingSeconds=this.config.breakDuration * 60;this.elements.breakTimer.textContent=Utils.formatTime(this.breakRemainingSeconds);this.elements.breakModal.classList.add("active");this.breakModalShown=true;NotificationManager.notifyBreak();this.skipBreakCountdown=15;this.elements.skipBreakBtn.textContent=`è·³è¿‡ä¼‘æ¯(${this.skipBreakCountdown}s)`;this.skipBreakInterval=setInterval(()=>{this.skipBreakCountdown--;if(this.skipBreakCountdown > 0){this.elements.skipBreakBtn.textContent=`è·³è¿‡ä¼‘æ¯(${this.skipBreakCountdown}s)`;}else{this._0x12();}},1000);this.breakModalTimeout=setTimeout(()=>{this._0x12();},15000);},_0x12(){if(this.breakModalTimeout){clearTimeout(this.breakModalTimeout);this.breakModalTimeout=null;}if(this.skipBreakInterval){clearInterval(this.skipBreakInterval);this.skipBreakInterval=null;}if(this.breakInterval){clearInterval(this.breakInterval);this.breakInterval=null;}this.isOnBreak=false;this.elements.breakModal.classList.remove("active");this.elements.skipBreakBtn.textContent="è·³è¿‡ä¼‘æ¯";this.lastBreakTime=new Date();this.breakModalShown=false;NotificationManager.breakNotified=false;},_0x13(){if(this.breakModalTimeout){clearTimeout(this.breakModalTimeout);this.breakModalTimeout=null;}if(this.skipBreakInterval){clearInterval(this.skipBreakInterval);this.skipBreakInterval=null;}this.elements.skipBreakBtn.textContent="è·³è¿‡ä¼‘æ¯";this.isOnBreak=true;this.lastBreakTime=new Date();this.breakStartTime=new Date();if(this.breakInterval){clearInterval(this.breakInterval);}this.breakInterval=setInterval(()=>{this.breakRemainingSeconds--;if(this.breakRemainingSeconds <=0){this._0x14();}else{this.elements.breakTimer.textContent=Utils.formatTime(this.breakRemainingSeconds);}},1000);},_0x14(){clearInterval(this.breakInterval);this.breakInterval=null;this.isOnBreak=false;this.breakModalShown=false;this.elements.breakModal.classList.remove("active");NotificationManager.breakNotified=false;},_0x15(){this.elements.timerDisplay.textContent="00:00:00";this.elements.status.textContent="ä¸‹ç­å•¦ï¼è¾›è‹¦äº†ï¼";this.elements.progressFill.style.width="100%";this._0x6();this.startTime=null;this.endTime=null;this.lunchStartTime=null;this.lunchEndTime=null;this.totalWorkSeconds=0;this.lastBreakTime=null;Config.clearTimerState();NotificationManager.reset();this.elements.startBtn.textContent="å¼€å§‹åŠ ç­";this.elements.startBtn.disabled=false;if(this.config.enableOffWorkNotify){NotificationManager.notifyOffWork();}},_0x16(){this.isOvertime=true;this.overtimeStartTime=new Date();this.overtimeSeconds=0;this.isRunning=true;this.elements.startBtn.textContent="æš‚åœ";this.elements.resetBtn.disabled=false;this.elements.status.textContent="åŠ ç­ä¸­...";this.interval=setInterval(()=> this._0xb(),1000);},_0x17(){const now=new Date();this.overtimeSeconds=Math.floor((now - this.overtimeStartTime)/ 1000);this.elements.timerDisplay.textContent="+" + Utils.formatTime(this.overtimeSeconds);this.elements.status.textContent="åŠ ç­ä¸­...";this.elements.progressFill.style.width="100%";},_0x18(){const state={startTime:this.startTime.toISOString(),endTime:this.endTime.toISOString(),lunchStartTime:this.lunchStartTime.toISOString(),lunchEndTime:this.lunchEndTime.toISOString(),totalWorkSeconds:this.totalWorkSeconds,isOvertime:this.isOvertime,overtimeStartTime:this.overtimeStartTime?this.overtimeStartTime.toISOString():null,};Config.saveTimerState(state);},_0x19(){this.elements.settingsModal.classList.add("active");},_0x1a(){this.elements.settingsModal.classList.remove("active");Config.applyConfigToUI(this.config);},_0x1b(){const newConfig=Config.getConfigFromUI();const _0x1c=this.config.startWorkTime !==newConfig.startWorkTime;const _0x1d=this.config.workHours !==newConfig.workHours;const _0x1e=this.config.lunchBreak !==newConfig.lunchBreak;const _0x1f=this.config.lunchTime !==newConfig.lunchTime;const _0x20=this.config.clockOffsetType !==newConfig.clockOffsetType||this.config.clockOffsetTime !==newConfig.clockOffsetTime;this.config=newConfig;Config.saveConfig(this.config);NotificationManager.config=this.config;this._0x1a();if(this.isRunning&&(_0x1c||_0x1d||_0x1e||_0x1f||_0x20)){this._0x21();}else if(!this.isRunning&&this.config.startWorkTime&&this.config.startWorkTime.trim()!==""){this._0x5();}},_0x21(){this._0x7();this._0x18();this._0xc();},_0x22(){NotificationManager.reset();NotificationManager.notifyLunch();},_0x23(){NotificationManager.reset();NotificationManager.notifyOffWork();},_0x24(){NotificationManager.reset();this._0x11();},_0x25(){if(!this.isRunning){alert("è¯·å…ˆå¼€å§‹ä¸Šç­è®¡æ—¶");return;}const now=new Date();this.endTime=new Date(now.getTime()+ 60000);this.elements.endTimeDisplay.textContent=Utils.formatTimeHHMM(this.endTime);this._0x18();this._0xc();alert("å·²è®¾ç½®ä¸ºä¸‹ç­å‰1åˆ†é’Ÿï¼\nä¸‹ç­æ—¶é—´ï¼š" + Utils.formatTimeHHMM(this.endTime));},async checkNotificationPermission(){const _0x26=document.getElementById("permissionStatus");const permission=window.Notification?.permission||"ä¸æ”¯æŒ";let html=`<strong>é€šçŸ¥æƒé™çŠ¶æ€ï¼š${permission}</strong><br><br>`;if(permission==="granted"){html +=` âœ… å·²æˆæƒé€šçŸ¥æƒé™<br> é€šçŸ¥å°†æ˜¾ç¤ºåœ¨ç³»ç»Ÿé€šçŸ¥ä¸­å¿ƒ `;}else if(permission==="denied"){html +=` âŒ é€šçŸ¥æƒé™å·²è¢«æ‹’ç»<br><br> <strong>å¦‚ä½•é‡æ–°å¯ç”¨ï¼š</strong><br><br> <strong>Chrome/Edge:</strong><br> 1. ç‚¹å‡»åœ°å€æ å·¦ä¾§çš„ ğŸ”’ å›¾æ ‡<br> 2. æ‰¾åˆ°"é€šçŸ¥"è®¾ç½®<br> 3. é€‰æ‹©"å…è®¸"<br> 4. åˆ·æ–°é¡µé¢<br><br> <strong>Firefox:</strong><br> 1. ç‚¹å‡»åœ°å€æ å·¦ä¾§çš„ ğŸ”’ å›¾æ ‡<br> 2. ç‚¹å‡»"æƒé™"<br> 3. æ‰¾åˆ°"é€šçŸ¥"å¹¶é€‰æ‹©"å…è®¸"<br> 4. åˆ·æ–°é¡µé¢<br><br> <strong>Safari:</strong><br> 1. Safarièœå• â†’ åå¥½è®¾ç½® â†’ ç½‘ç«™<br> 2. ç‚¹å‡»"é€šçŸ¥"<br> 3. æ‰¾åˆ°æœ¬ç½‘ç«™å¹¶é€‰æ‹©"å…è®¸"<br> 4. åˆ·æ–°é¡µé¢ `;}else if(permission==="default"){html +=` âš ï¸ å°šæœªæˆæƒé€šçŸ¥æƒé™<br><br> ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è¯·æ±‚æƒé™ï¼š `;_0x26.innerHTML=html;_0x26.style.display="block";const _0x27=document.createElement("button");_0x27.textContent="è¯·æ±‚é€šçŸ¥æƒé™";_0x27.className="btn btn-primary";_0x27.style.marginTop="10px";_0x27.onclick=async()=>{const result=await window.Notification.requestPermission();this.checkNotificationPermission();};_0x26.appendChild(_0x27);return;}else{html +=` âŒ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥åŠŸèƒ½<br><br> å»ºè®®ä½¿ç”¨ä»¥ä¸‹æµè§ˆå™¨ï¼š<br> â€¢ Chrome æµè§ˆå™¨<br> â€¢ Firefox æµè§ˆå™¨<br> â€¢ Edge æµè§ˆå™¨<br> â€¢ Safari æµè§ˆå™¨ `;}_0x26.innerHTML=html;_0x26.style.display="block";},_0x28(e){const customSoundGroup=document.getElementById("customSoundGroup");if(e.target.value==="custom"){customSoundGroup.style.display="block";}else{customSoundGroup.style.display="none";}},_0x29(e){const file=e.target.files[0];if(!file)return;if(!file.type.startsWith("audio/")){alert("è¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶ï¼");e.target.value="";return;}if(file.size > 5 * 1024 * 1024){alert("æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MBï¼");e.target.value="";return;}const reader=new FileReader();reader.onload=(event)=>{const base64Data=event.target.result;Config.saveCustomSound(base64Data);const preview=document.getElementById("customSoundPreview");preview.textContent=`âœ“ å·²é€‰æ‹©ï¼š${file.name}`;preview.style.color="#667eea";};reader.onerror=()=>{alert("æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•ï¼");e.target.value="";};reader.readAsDataURL(file);},_0x2a(e){const devModeSection=document.getElementById("devModeSection");if(e.target.checked){devModeSection.style.display="block";}else{devModeSection.style.display="none";}},};document.addEventListener("DOMContentLoaded",()=>{Timer.init();});